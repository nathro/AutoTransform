# AutoTransform
# Large scale, component based code modification library
#
# Licensed under the MIT License <http://opensource.org/licenses/MIT>
# SPDX-License-Identifier: MIT
# Copyright (c) 2022-present Nathan Rockenbach <http://github.com/nathro>

name: Release

on:
  push:
    branches:
      - 'releases/**'

jobs:
  build:
    runs-on: ubuntu-latest
    name: Validate and publish package
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python 3.10
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Update pip
      run: pip install --upgrade pip
    - name: Install Dependencies
      run: pip install -r requirements.txt
    - name: Check mypy
      run: mypy src/python/autotransform tests
    - name: Check pytest
      run: pytest -W ignore::DeprecationWarning tests/
      env:
        PYTHONPATH: /home/runner/work/AutoTransform/AutoTransform/src/python
        AUTO_TRANSFORM_CONFIG: environment
        AUTO_TRANSFORM_CREDENTIALS_GITHUB_TOKEN: ${{ github.token }}
    - name: Check pylint on source
      run: pylint --enable=W0611,R0902,R0903,R0913,R1732 --disable=C0103,C0411,R0401,R0801,R0914,R0915 src/python/autotransform
    - name: Check pylint on tests
      run: pylint --enable=W0611,R0902,R1732 --disable=C0103,C0114,C0115,C0116,C0301,C0411,R0401,R0801,R0913,R0914,R0915,W0212,W0613,W0621 src/python/autotransform
    - name: Build
      run: python3 -m build
    - name: Publish
      run: python3 -m twine upload dist/*
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.TWINE_TOKEN }}
        TWINE_REPOSITORY: pypi